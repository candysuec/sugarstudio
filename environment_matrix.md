# Phase 13: Environment Matrix (Updated)

This matrix details the discovered environment variables across the SugarStudio monorepo, their definitions, and usage locations, reflecting the latest changes.

---

## 1. Environment Variable Files Discovered

*   `/.env.shared`
*   `/apps/candyland/.env.example`
*   `/apps/candyland/.env.local`
*   `/apps/knisoci/.env.example`
*   `/apps/knisoci/.env.local`
*   `/apps/orchestrator/.env.example`
*   `/apps/website/.env.example`
*   `/packages/supabase-client/.env.template`

---

## 2. Environment Variables Matrix

| Variable Name                 | Defined In                 | Example Value / Status                                    | Used In (Code)                                                                                                                                                                                                                                                                | Notes                                                                                                                                                                                                     |
| :---------------------------- | :------------------------- | :-------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `SUPABASE_URL`                | `/.env.shared`             | "YOUR_SUPABASE_URL"                                       | `packages/supabase-client/src/index.ts`, `packages/supabase-client/index.js`, `apps/orchestrator/src/utils/env.ts`                                                                                                                                                            | Used for server-side Supabase client initialization.                                                                                                                                                      |
| `SUPABASE_ANON_KEY`           | `/.env.shared`             | "YOUR_SUPABASE_ANON_KEY"                                  | `packages/supabase-client/src/index.ts`, `packages/supabase-client/index.js`, `apps/orchestrator/src/utils/env.ts`                                                                                                                                                            | Used for server-side Supabase client initialization.                                                                                                                                                      |
| `SUPABASE_SERVICE_ROLE_KEY`   | `/.env.shared`             | "YOUR_SUPABASE_SERVICE_ROLE_KEY"                          | `packages/supabase-client/index.ts`                                                                                                                                                                                                                                   | Sensitive, server-only key.                                                                                                                                                                               |
| `ORCHESTRATOR_API_KEY`        | `/.env.shared`             | "YOUR_ORCHESTRATOR_API_KEY"                               | `apps/website/app/api/dispatch-job/route.ts`                                                                                                                                                                                                                          |                                                                                                                                                                                                           |
| `GEMINI_API_KEY`              | `/.env.shared`             | "YOUR_GEMINI_API_KEY"                                     | `knisoci` (various API routes, selfrepair, logs etc - inferred from build logs)                                                                                                                                                                                         | **Conflict**: Used interchangeably with `GOOGLE_GENERATIVE_AI_API_KEY`.                                                                                                                                   |
| `NOTION_API_KEY`              | `/.env.shared`, `orchestrator/.env.example` | "YOUR_NOTION_API_KEY"                                     | `knisoci` (notion-related API routes), `apps/orchestrator/src/utils/env.ts`                                                                                                                                                                                           |                                                                                                                                                                                                           |
| `NOTION_DATABASE_ID`          | `/.env.shared`, `orchestrator/.env.example` | "YOUR_NOTION_DATABASE_ID"                                 | `knisoci` (notion-related API routes), `apps/orchestrator/src/utils/env.ts`                                                                                                                                                                                           |                                                                                                                                                                                                           |
| `NEXT_PUBLIC_SUPABASE_URL`    | `/.env.shared`             | "${SUPABASE_URL}" (derived)                               | `knisoci` (lib/supabase/server.ts, edge.ts), `candyland` (lib/supabase/edge.ts, server.ts), `website` (lib/supabase/client.ts, server.ts)                                                                                                                           | Intended for public client-side Supabase access.                                                                                                                                                          |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | `/.env.shared`             | "${SUPABASE_ANON_KEY}" (derived)                          | `knisoci` (lib/supabase/server.ts, edge.ts), `candyland` (lib/supabase/edge.ts, server.ts), `website` (lib/supabase/client.ts, server.ts)                                                                                                                           | Intended for public client-side Supabase access.                                                                                                                                                          |
| `NEXT_PUBLIC_API_BASE_URL`    | `/.env.shared`             | "http://localhost:3010"                                   | `packages/foundation/config/browser.ts`                                                                                                                                                                                                                         | Public base URL for the Orchestrator API.                                                                                                                                                                 |
| `LOCAL_LOG_LEVEL`             | `/.env.shared`             | "info"                                                    | (Inferred usage)                                                                                                                                                                                                                                                      |                                                                                                                                                                                                           |
| `NEXT_PUBLIC_SITE_URL`        | `/.env.shared`             | "https://candystudio.ai"                                  | `apps/website/app/layout.tsx`                                                                                                                                                                                                                                         | **Status**: Now defined in `/.env.shared`. Needs build confirmation.                                                                                                                                      |
| `NEXT_PUBLIC_WEBSITE_VAR`     | `/.env.shared`, `website/.env.example` | "This is a public variable for the website"               | (Inferred usage)                                                                                                                                                                                                                                                      |                                                                                                                                                                                                           |
| `NEXT_PUBLIC_KNISOCI_VAR`     | `/.env.shared`, `knisoci/.env.example` | "This is a public variable for KniSoci"                   | (Inferred usage)                                                                                                                                                                                                                                                      |                                                                                                                                                                                                           |
| `NEXT_PUBLIC_CANDYLAND_VAR`   | `/.env.shared`, `candyland/.env.example` | "This is a public variable for Candyland"                 | (Inferred usage)                                                                                                                                                                                                                                                      |                                                                                                                                                                                                           |
| `GOOGLE_GENERATIVE_AI_API_KEY` | (Used in code)             |                                                           | `knisoci` (listModels.js, app/api/system-check/route.ts, lib/selfrepair.ts, lib/geminiUtils.ts, lib/weekly.ts)                                                                                                                                                          | **Conflict**: Used interchangeably with `GEMINI_API_KEY`. Not defined in `env.shared`.                                                                                                                    |
| `GOOGLE_CLIENT_ID`            | (Used in code)             |                                                           | `knisoci` (src/auth.ts, app/api/debug/env/route.ts, app/api/system-check/route.ts, lib/auth.ts)                                                                                                                                                                       | Not defined in `env.shared`.                                                                                                                                                                              |
| `GOOGLE_CLIENT_SECRET`        | (Used in code)             |                                                           | `knisoci` (src/auth.ts, app/api/system-check/route.ts, lib/auth.ts)                                                                                                                                                                                                   | Not defined in `env.shared`.                                                                                                                                                                              |
| `NEXTAUTH_SECRET`             | (Used in code)             |                                                           | `knisoci` (src/auth.ts, app/api/debug/env/route.ts, app/api/system-check/route.ts)                                                                                                                                                                                    | Not defined in `env.shared`.                                                                                                                                                                              |
| `NEXTAUTH_URL`                | (Used in code)             |                                                           | `knisoci` (app/api/debug/env/route.ts, app/api/generate/selfrepair/cron/hourly/route.ts)                                                                                                                                                                              | Not defined in `env.shared`.                                                                                                                                                                              |
| `ADMIN_ACCESS_KEY`            | (Used in code)             |                                                           | `knisoci` (src/proxy.ts, app/api/generate/selfrepair/alert-test/route.ts, app/api/generate/selfrepair/cron/hourly/route.ts)                                                                                                                                              | Not defined in `env.shared`.                                                                                                                                                                              |
| `NEXT_PUBLIC_ADMIN_ACCESS_KEY` | (Used in code)             |                                                           | `knisoci` (src/components, app/dashboard/ admin/selfrepair/page.tsx)                                                                                                                                                                                                | Not defined in `env.shared`.                                                                                                                                                                              |
| `DISCORD_WEBHOOK_URL`         | (Used in code)             |                                                           | `knisoci` (app/api/alerts/discord/route.ts)                                                                                                                                                                                                                         | Not defined in `env.shared`.                                                                                                                                                                              |
| `SLACK_WEBHOOK_URL`           | (Used in code)             |                                                           | `knisoci` (app/api/alerts/slack/route.ts)                                                                                                                                                                                                                           | Not defined in `env.shared`.                                                                                                                                                                              |
| `ALERTS_PROVIDER`             | (Used in code)             | "resend" (default)                                        | `knisoci` (app/api/generate/selfrepair/alert-test/route.ts, app/api/generate/selfrepair/logs/route.ts, lib/alerts/mailer.ts)                                                                                                                                           | Not defined in `env.shared`.                                                                                                                                                                              |
| `ALERTS_MIN_LEVEL`            | (Used in code)             | "warn" (default)                                          | `knisoci` (lib/alerts/mailer.ts)                                                                                                                                                                                                                                    | Not defined in `env.shared`.                                                                                                                                                                              |
| `ALERTS_TO`                   | (Used in code)             |                                                           | `knisoci` (app/api/generate/selfrepair/alert-test/route.ts)                                                                                                                                                                                                         | The recipient for alert emails. Not defined in `env.shared`.                                                                                                                                              |
| `APP_BASE_URL`                | (Used in code)             | "http://localhost:3000" (default)                         | `knisoci` (app/api/generate/selfrepair/cron/daily/route.ts, lib/daily.ts, lib/alerts/mailer.ts)                                                                                                                                                                       | Not defined in `env.shared`.                                                                                                                                                                              |
| `NOTION_TOKEN`                | (Used in code)             |                                                           | `knisoci` (app/api/export/notion/route.ts)                                                                                                                                                                                                                          | Sensitive. Not defined in `env.shared`.                                                                                                                                                                   |
| `NOTION_PARENT_PAGE_ID`       | (Used in code)             |                                                           | `knisoci` (app/api/export/notion/route.ts)                                                                                                                                                                                                                          | Not defined in `env.shared`.                                                                                                                                                                              |
| `SELFREPAIR_RETENTION_DAYS`   | (Used in code)             | "30" (default)                                            | `knisoci` (lib/logs.ts)                                                                                                                                                                                                                                               | Controls how long self-repair logs are retained. Not defined in `env.shared`.                                                                                                                             |
| `NODE_ENV`                    | (Used in code - default)   | "production" / "development"                              | `knisoci` (lib/db.ts, lib/selfrepair.ts), `candyland` (lib/ai/aiClient.js)                                                                                                                                                                                           | Automatically set by runtime environments.                                                                                                                                                                |
| `OPENAI_API_KEY`              | (Used in code)             |                                                           | `candyland` (lib/ai/aiClient.js)                                                                                                                                                                                                                                    | Not defined in `env.shared`.                                                                                                                                                                              |
| `PORT`                        | `orchestrator/.env.example` | 3010 (default), 3010                                      | `apps/orchestrator/src/utils/env.ts`, `apps/orchestrator/server.js`                                                                                                                                                                                                 | Server port for orchestrator.                                                                                                                                                                             |

---

## 3. Unset or Conflicting Variables Identified (Updated)

1.  **`NEXT_PUBLIC_SITE_URL`**:
    *   **Status**: **DEFINED** in `/.env.shared`.
    *   **Impact**: The `metadataBase` warning should now be resolved during the next build. This needs confirmation.
2.  **`GEMINI_API_KEY` vs. `GOOGLE_GENERATIVE_AI_API_KEY`**:
    *   **Status**: **CONFLICT** and inconsistent usage persists.
    *   **Impact**: Code relies on both names, which can lead to confusion and potential failure if both are not set or if only one is updated. `GOOGLE_GENERATIVE_AI_API_KEY` is not defined in `/.env.shared`.
3.  **Missing Definitions in `/.env.shared`**:
    *   **Status**: Many variables used in code (`GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `NEXTAUTH_SECRET`, `NEXTAUTH_URL`, `ADMIN_ACCESS_KEY`, `NOTION_TOKEN`, `OPENAI_API_KEY`, webhook URLs) are *not* defined in `/.env.shared`.
    *   **Impact**: Lack of clear documentation for required environment variables, leading to setup difficulties and potential runtime errors.
4.  **Supabase Client Variable Access**:
    *   **Status**: Inconsistent access patterns for Supabase keys within `packages/supabase-client`. The package appears to use both `SUPABASE_URL`/`SUPABASE_ANON_KEY` (non-public) and `NEXT_PUBLIC_SUPABASE_URL`/`NEXT_PUBLIC_SUPABASE_ANON_KEY` (public).
    *   **Impact**: Potential confusion and incorrect client initialization depending on the context (server-side vs. client-side, protected vs. public endpoints).

---

## 4. Phase 13 Fix Plan

1.  **Standardize Gemini API Keys**:
    *   **Action**: Choose `GOOGLE_GENERATIVE_AI_API_KEY` as the standard.
    *   **Action**: Add `GOOGLE_GENERATIVE_AI_API_KEY="YOUR_GEMINI_API_KEY"` to `/.env.shared`.
    *   **Action**: Remove `GEMINI_API_KEY` from `/.env.shared`.
    *   **Action**: Update all code using `GEMINI_API_KEY` to use `GOOGLE_GENERATIVE_AI_API_KEY`.
2.  **Centralize All Shared Public Variables in `/.env.shared`**:
    *   **Action**: Add `APP_BASE_URL="http://localhost:3000"` to `/.env.shared`.
    *   **Action**: Add `NEXT_PUBLIC_ADMIN_ACCESS_KEY="YOUR_ADMIN_ACCESS_KEY"` to `/.env.shared`.
3.  **Centralize All Secret/Sensitive Variables in Root `/.env.local`**:
    *   **Action**: Move all sensitive environment variables (e.g., `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `NEXTAUTH_SECRET`, `NEXTAUTH_URL`, `ADMIN_ACCESS_KEY`, `NOTION_TOKEN`, `OPENAI_API_KEY`, `DISCORD_WEBHOOK_URL`, `SLACK_WEBHOOK_URL`, `ALERTS_PROVIDER`, `ALERTS_MIN_LEVEL`, `ALERTS_TO`, `SELFREPAIR_RETENTION_DAYS`) to the root `.env.local` file.
    *   **Rationale**: The root `.env.local` is the designated place for machine-specific/deployment-specific secrets that are not committed to version control.
4.  **Standardize Supabase Client Variable Access**:
    *   **Action**: Review `packages/supabase-client/index.js` and `src/index.ts` and `packages/supabase-client/index.ts`.
    *   **Action**: Ensure `packages/supabase-client` consistently uses `SUPABASE_URL`/`SUPABASE_ANON_KEY` for server-side/service role clients and `NEXT_PUBLIC_SUPABASE_URL`/`NEXT_PUBLIC_SUPABASE_ANON_KEY` for public/client-side clients. This might involve creating distinct client functions within the package.
5.  **Clean up App-Specific `.env.example` Files**:
    *   **Action**: Remove duplicated variable definitions in `apps/*/ .env.example` files that are already covered by `/.env.shared` or are meant for `/.env.local`. Keep only variables unique to the specific app examples.

---

**Waiting for confirmation before applying any changes.**